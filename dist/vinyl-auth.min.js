"use strict";var Vinyl=Vinyl||{};Vinyl.VinylAuth=function(b){function f(){g(),c.refreshTokenPath&&p()}function g(){var a=l.bind(this);window.addEventListener&&window.addEventListener("message",a,!1)}function h(a){return window.open(a,"_blank","closebuttoncaption=Cancel")}function i(a){null==a?k({reason:"unauthorized",errors:["Auth window failed to open"]}):a.closed?j():(a.postMessage("requestCredentials","*"),d=setTimeout(function(){i(a)},c.requestCredentialsPollingTimerInterval))}function j(){k({reason:"unauthorized",errors:["User canceled login"]})}function k(a){d&&clearTimeout(d),c.handleAuthFailure(a),setTimeout(function(){d=null},0)}function l(a){if("deliverCredentials"==a.data.message&&(delete a.data.message,s(a.data),m(a.data)),"authFailure"==a.data.message){var b={reason:"unauthorized",errors:[a.data.error]};k(b)}}function m(a){d&&clearTimeout(d),c.handleAuthSuccess(a)}function n(a){a=a||!1,c.handleAuthStart({message:"Auth has started",forceAuth:a});var b=r();!a&&b?m(b):q()}function o(){var a=r();if(a){var b=new XMLHttpRequest,d=c.refreshTokenPath+"?token="+a.auth_token;b.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var a=JSON.parse(this.responseText);s(a)}else 4==this.readyState&&(s(null),c.handleAuthTokenExpiry({message:"Token has expired"}))},b.open("GET",d,!0),b.send()}p()}function p(){setTimeout(o,1e3*c.refreshTokenInterval)}function q(){i(h(c.authProviderPath))}function r(){return null==e&&c.storage&&(e=c.storage.get()),e}function s(a){e=a,c.storage&&c.storage.set(a,c.storageTTL)}function t(){e=null,c.storage&&c.storage.set(null),c.handleAuthLogout({message:"Logout"})}var d,c={authProviderPath:b.authProviderPath||"",handleAuthSuccess:b.handleAuthSuccess||console.log,handleAuthFailure:b.handleAuthFailure||console.log,handleAuthStart:b.handleAuthStart||console.log,handleAuthLogout:b.handleAuthLogout||console.log,handleAuthTokenExpiry:b.handleAuthTokenExpiry||console.log,storage:b.storage||null,storageTTL:b.storageTTL||1200,refreshTokenPath:b.refreshTokenPath||null,refreshTokenInterval:b.refreshTokenInterval||600,requestCredentialsPollingTimerInterval:500},e=null;return{initialize:f,authenticate:n,getRecord:r,logout:t}},Vinyl.VinylStorage=function(b){function c(){var a=b.getItem("vinylRecord");if(null==a)return!1;try{var c=JSON.parse(a)}catch(a){return!1}return!(c.TTL<e())&&c}function d(a,c){return null==a?delete b.vinylRecord:(a.TTL=e()+c,void b.setItem("vinylRecord",JSON.stringify(a)))}function e(){return Math.floor(Date.now()/1e3)}return{get:c,set:d}};